version: '3.8'

volumes:
  ch_data_01:
  ch_data_02:
  ch_keeper_data:

services:
  ### ClickHouse Keeper (замена ZooKeeper)
  keeper-01:
    image: clickhouse/clickhouse-keeper:25.3
    container_name: ch-keeper-01
    ports:
      - "2181:2181"    # клиентский порт (изменяй слева)
      - "9181:9181"    # HTTP мониторинг
      - "9444:9444"    # raft (внутренний, не трогай)
    volumes:
      - ./configs/keeper_config.xml:/etc/clickhouse-keeper/keeper_config.xml:ro
      - ch_keeper_data:/var/lib/clickhouse-keeper
    command: --tcp-port 2181 --raft-configuration 0:keeper-01:9444
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9181/op_status"]
      interval: 30s
      timeout: 10s
      retries: 3

  ### Шард 1, Реплика 1
  ch01:
    image: clickhouse/clickhouse-server:25.3
    container_name: ch-shard01-01
    ports:
      - "8123:8123"     # HTTP интерфейс (DBeaver) ← ОСНОВНОЙ
      - "9002:9000"     # Native TCP (CLI, JDBC)
      - "9009:9009"     # Interserver HTTP
    environment:
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: clickhouse
    volumes:
      - ch_data_01:/var/lib/clickhouse
      - ./configs/remote_servers.xml:/etc/clickhouse-server/config.d/remote_servers.xml:ro
      - ./configs/users.xml:/etc/clickhouse-server/users.d/users.xml:ro
      - ./configs/macros/shard01.xml:/etc/clickhouse-server/config.d/macros.xml:ro
    depends_on:
      keeper-01:
        condition: service_healthy
    restart: always
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  ### Шард 2, Реплика 1
  ch02:
    image: clickhouse/clickhouse-server:25.3
    container_name: ch-shard02-01
    ports:
      - "8124:8123"     # HTTP (DBeaver для 2го шарда)
      - "9003:9000"     # Native TCP
      - "9010:9009"     # Interserver
    environment:
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: clickhouse
    volumes:
      - ch_data_02:/var/lib/clickhouse
      - ./configs/remote_servers.xml:/etc/clickhouse-server/config.d/remote_servers.xml:ro
      - ./configs/users.xml:/etc/clickhouse-server/users.d/users.xml:ro
      - ./configs/macros/shard02.xml:/etc/clickhouse-server/config.d/macros.xml:ro
    depends_on:
      keeper-01:
        condition: service_healthy
    restart: always
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

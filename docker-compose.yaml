version: '3.8'

volumes:
  ch_data_01:
  ch_data_02:
  ch_keeper_data:

services:
  ### ClickHouse Keeper (–∑–∞–º–µ–Ω–∞ ZooKeeper) - –£–ü–†–û–©–Å–ù–ù–´–ô HEALTHCHECK
  keeper-01:
    image: clickhouse/clickhouse-keeper:25.3
    container_name: ch-keeper-01
    ports:
      - "2181:2181"    # –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç (ZooKeeper –ø—Ä–æ—Ç–æ–∫–æ–ª)
      - "9181:9181"    # HTTP –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
      - "9444:9444"    # raft (–ù–ï –ú–ï–ù–Ø–ô)
    volumes:
      - ./configs/keeper_config.xml:/etc/clickhouse-keeper/keeper_config.xml:ro
      - ch_keeper_data:/var/lib/clickhouse-keeper
    command: --tcp-port 2181 --raft-configuration 0:keeper-01:9444
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost 2181 2>/dev/null | grep imok || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  ### –®–ê–†–î 1, –†–ï–ü–õ–ò–ö–ê 1
  ch01:
    image: clickhouse/clickhouse-server:25.3
    container_name: ch-shard01-replica01
    ports:
      - "8123:8123"     # üî• HTTP –æ—Å–Ω–æ–≤–Ω–æ–π (DBeaver/Airflow)
      - "9000:9000"     # Native TCP (CLI/JDBC)
      - "9009:9009"     # Interserver HTTP
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: clickhouse
    volumes:
      - ch_data_01:/var/lib/clickhouse
      - ./configs/remote_servers.xml:/etc/clickhouse-server/config.d/remote_servers.xml:ro
      - ./configs/users.xml:/etc/clickhouse-server/users.d/users.xml:ro
      - ./configs/macros/shard01.xml:/etc/clickhouse-server/config.d/macros.xml:ro
    depends_on:
      - keeper-01
    restart: always
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ### –®–ê–†–î 2, –†–ï–ü–õ–ò–ö–ê 1
  ch02:
    image: clickhouse/clickhouse-server:25.3
    container_name: ch-shard02-replica01
    ports:
      - "8124:8123"     # HTTP —à–∞—Ä–¥ 2
      - "9001:9000"     # Native TCP —à–∞—Ä–¥ 2
      - "9010:9009"     # Interserver —à–∞—Ä–¥ 2
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: clickhouse
    volumes:
      - ch_data_02:/var/lib/clickhouse
      - ./configs/remote_servers.xml:/etc/clickhouse-server/config.d/remote_servers.xml:ro
      - ./configs/users.xml:/etc/clickhouse-server/users.d/users.xml:ro
      - ./configs/macros/shard02.xml:/etc/clickhouse-server/config.d/macros.xml:ro
    depends_on:
      - keeper-01
    restart: always
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
